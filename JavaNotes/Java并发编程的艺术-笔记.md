并发编程的目的是为了让程序运行得更快，但是，并不是启动更多的线程就能让程序最大限度地并发执行。  

# 并发编程的挑战以及解决方案
## 上下文切换
任务从保存到再加载的过程就是一次上下文切换。

这就像我们同时读两本书，当我们在读一本英文的技术书时，发现某个单词不认识，于是便打开中英文字典，但是在放下英文技术书之前，大脑必须先记住这本书读到了多少页的第多少行，等查完单词之后，能够继续读这
本书。这样的切换是会影响读书效率的，同样上下文切换也会影响多线程的执行速度。

### 多线程一定快吗？
不对，当并发执行累加操作不超过百万次时，速度会比串行执行累加操作要慢。因为线程有创建和上下文切换的开销。

### 测试上下文切换次数和时长
* 使用Lmbench3(一个性能分析工具)可以测量上下文切换的时长。
* 使用vmstat可以测量上下文切换的次数。

### 如何减少上下文切换
* **无锁并发编程**。多线程竞争锁时，会引起上下文切换，所以多线程处理数据时，可以用一
些办法来避免使用锁，如将数据的ID按照Hash算法取模分段，不同的线程处理不同段的数据。
* **CAS算法**。Java的Atomic包使用CAS算法来更新数据，而不需要加锁。
* **使用最少线程**。避免创建不需要的线程，比如任务很少，但是创建了很多线程来处理，这
样会造成大量线程都处于等待状态。
* **协程**。在单线程里实现多任务的调度，并在单线程里维持多个任务间的切换。

## 死锁
在一些复杂的场景中，你可能会遇到这样的问题，比如t1拿到锁之后，因为一些异常情况没有释放锁
（死循环）。又或者是t1拿到一个数据库锁，释放锁的时候抛出了异常，没释放掉。

避免死锁的几个常见方法。  
* 避免一个线程同时获取多个锁。
* 避免一个线程在锁内同时占用多个资源，尽量保证每个锁只占用一个资源。
* 尝试使用定时锁，使用lock.tryLock（timeout）来替代使用内部锁机制。
* 对于数据库锁，加锁和解锁必须在一个数据库连接里，否则会出现解锁失败的情况。

## 资源限制的挑战
（1）什么是资源限制  
资源限制是指在进行并发编程时，程序的执行速度受限于计算机硬件资源或软件资源。  
（2）资源限制引发的问题  
在并发编程中，将代码执行速度加快的原则是将代码中串行执行的部分变成并发执行，
但是如果将某段串行的代码并发执行，因为受限于资源，仍然在串行执行，这时候程序不仅不
会加快执行，反而会更慢，因为增加了上下文切换和资源调度的时间。  
（3）如何解决资源限制的问题  
对于硬件资源限制，可以考虑使用集群并行执行程序。  
（4）在资源限制情况下进行并发编程  
如何在资源限制的情况下，让程序执行得更快呢？方法就是，根据不同的资源限制调整
程序的并发度，比如下载文件程序依赖于两个资源——带宽和硬盘读写速度。  

# Java并发机制的底层实现原理
Java代码在编译后会变成Java字节码，字节码被类加载器加载到JVM里，JVM执行字节
码，最终需要转化为汇编指令在CPU上执行，Java中所使用的并发机制依赖于JVM的实现和
CPU的指令。  







